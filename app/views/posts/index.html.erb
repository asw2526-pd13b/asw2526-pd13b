<% content_for :title, "Posts" %>

<div class="PageHeader">
  <div>
    <h1 class="PageTitle">Posts</h1>
  </div>
  <div class="Pills">
    <%= link_to "Create post", new_post_path, class: "btn btn-primary" %>
  </div>
</div>

<div class="Card CardPad" style="box-shadow:none;">
  <div class="Stack" style="gap:10px;">
    <%= form_with url: posts_path, method: :get, local: true do %>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <label class="sr-only" for="q">Search</label>
        <%= text_field_tag :q, params[:q], id: "q", class: "Input", placeholder: "Search by title or text…" %>
        <% if params[:filter].present? %>
          <%= hidden_field_tag :filter, params[:filter] %>
        <% end %>
        <% if params[:sort].present? %>
          <%= hidden_field_tag :sort, params[:sort] %>
        <% end %>
        <%= submit_tag "Search", class: "btn" %>
        <% if params[:q].present? %>
          <%= link_to "Clear", posts_path(filter: params[:filter], sort: params[:sort]), class: "btn btn-ghost" %>
        <% end %>
      </div>
    <% end %>

    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;">
      <div class="Pills">
        <% filter = params[:filter].presence || "all" %>
        <%= link_to "All", posts_path(sort: params[:sort], q: params[:q]), class: "pill #{'is-active' if filter == 'all'}" %>
        <%= link_to "Subscribed", posts_path(filter: "subscribed", sort: params[:sort], q: params[:q]), class: "pill #{'is-active' if filter == 'subscribed'}" %>
        <%= link_to "Local", posts_path(filter: "local", sort: params[:sort], q: params[:q]), class: "pill #{'is-active' if filter == 'local'}" %>
      </div>

      <div class="Pills">
        <% sort = params[:sort].presence || "new" %>
        <%= link_to "New", posts_path(sort: "new", filter: params[:filter], q: params[:q]), class: "pill #{'is-active' if sort == 'new'}" %>
        <%= link_to "Old", posts_path(sort: "old", filter: params[:filter], q: params[:q]), class: "pill #{'is-active' if sort == 'old'}" %>
        <%= link_to "Most comments", posts_path(sort: "comments", filter: params[:filter], q: params[:q]), class: "pill #{'is-active' if sort == 'comments'}" %>
        <%= link_to "Top", posts_path(sort: "top", filter: params[:filter], q: params[:q]), class: "pill #{'is-active' if sort == 'top'}" %>
      </div>
    </div>
  </div>
</div>

<% if @posts.any? %>
  <div class="Stack" style="margin-top:12px;">
    <% @posts.each do |post| %>
      <% vv = vote_value_for(post) %>
      <article class="Card PostCard">
        <div style="padding:14px 0 14px 14px;display:flex;align-items:flex-start;">
          <div class="VoteStack">
            <%= button_to vote_path("Post", post.id, 1), method: :post, class: "VoteBtn #{'is-upvoted' if vv == 1}", form: { class: "inline" } do %>↑<% end %>
            <div class="VoteScore"><%= post.score %></div>
            <%= button_to vote_path("Post", post.id, -1), method: :post, class: "VoteBtn #{'is-downvoted' if vv == -1}", form: { class: "inline" } do %>↓<% end %>
          </div>
        </div>

        <div style="padding:14px 0 14px 0;">
          <% if post.image.attached? %>
            <%= link_to post_path(post), style: "display:inline-block;" do %>
              <% if post.image.variable? %>
                <%= image_tag post.image.variant(resize_to_fill: [96, 96]), class: "Thumb" %>
              <% else %>
                <%= image_tag post.image, class: "Thumb" %>
              <% end %>
            <% end %>
          <% else %>
            <div class="ThumbPlaceholder">∷</div>
          <% end %>
        </div>

        <div style="padding:14px 14px 14px 0;min-width:0;">
          <h2 class="PostTitle">
            <% if post.url.present? %>
              <%= link_to post.title, post.url, target: "_blank", rel: "noopener" %>
            <% else %>
              <%= link_to post.title, post_path(post) %>
            <% end %>
          </h2>

          <div class="PostMeta">
            <% if post.community.present? %>
              <span class="Badge"><%= link_to "c/#{post.community.slug}", community_path(post.community) %></span>
            <% else %>
              <span class="Badge">no community</span>
            <% end %>
            <span>by <%= link_to post.user.display_name, user_path(post.user) %> (@<%= post.user.username %>)</span>
            <span>· <%= time_ago_in_words(post.created_at) %> ago</span>
            <span>· <%= (post.try(:comments_count) || post.comments.count) %> comments</span>
          </div>

          <% if post.body.present? %>
            <div class="PostExcerpt"><%= truncate(post.body, length: 220) %></div>
          <% end %>

          <div class="PostFooter">
            <div></div>
            <div class="Pills">
              <%= link_to "Go To Post", post_path(post), class: "btn btn-ghost" %>
              <% if post.url.present? %>
                <%= link_to "Open link", post.url, target: "_blank", rel: "noopener", class: "btn btn-ghost" %>
              <% end %>
            </div>
          </div>
        </div>
      </article>
    <% end %>
  </div>
<% else %>
  <div class="Card CardPad Empty" style="margin-top:12px;">
    No posts yet.
  </div>
<% end %>
