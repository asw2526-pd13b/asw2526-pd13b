<h1>Posts</h1>
<!--  Cercador simple de posts -->
<%= form_with url: posts_path, method: :get, local: true do %>
  <div style="margin: 0 0 1rem 0;">
    <%= label_tag :q, "Cercar:" %>
    <%= text_field_tag :q, params[:q], placeholder: "Títol o cos...", style: "width:220px" %>
    <%= submit_tag "Cerca" %>
  </div>
<% end %>
<!--  Fi cercador -->
<!--  Filtres -->
<div style="margin: 0 0 1rem 0;">
  <strong>Filtres:</strong>
  <%= link_to "Tots", posts_path %> |
  <%= link_to "Subscrit", posts_path(filter: "subscribed") %> |
  <%= link_to "Local", posts_path(filter: "local") %>
</div>

<!-- Ordenació -->
<div style="margin: 0 0 1rem 0;">
  <strong>Ordenar per:</strong>
  <%= link_to "Nou", posts_path(sort: "new",      filter: params[:filter], q: params[:q]) %> |
  <%= link_to "Antic", posts_path(sort: "old",     filter: params[:filter], q: params[:q]) %> |
  <%= link_to "Més comentaris", posts_path(sort: "comments", filter: params[:filter], q: params[:q]) %> |
  <%= link_to "El millor", posts_path(sort: "top",    filter: params[:filter], q: params[:q]) %>
</div>

<p>
  <%= link_to "Communities", communities_path %> |
  <%= link_to "New Community", new_community_path %>
</p>

<p><%= link_to "Create Post", new_post_path %></p>

<% if @posts.any? %>
  <ul style="list-style:none; padding-left:0;">
    <% @posts.each do |post| %>
      <li style="margin: 16px 0; padding: 12px 0; border-bottom: 1px solid #ddd;">
        <div style="display:flex; gap:12px; align-items:flex-start;">
          <!-- Miniatura cuadrada -->
          <% if post.image.attached? %>
            <%= link_to post_path(post), style: "display:block; flex:0 0 auto;" do %>
              <% if post.image.variable? %>
                <%= image_tag post.image.variant(resize_to_fill: [96, 96]),
                      style: "width:96px;height:96px;object-fit:cover;border-radius:8px;display:block;" %>
              <% else %>
                <%= image_tag post.image,
                      style: "width:96px;height:96px;object-fit:cover;border-radius:8px;display:block;" %>
              <% end %>
            <% end %>
          <% else %>
            <!-- Placeholder si no hay imagen -->
            <div style="width:96px;height:96px;border-radius:8px;background:#eee;flex:0 0 auto;"></div>
          <% end %>

          <!-- Contenido -->
          <div style="min-width:0;">
            <div>
              <strong>
                <%= link_to post.title, post.url, target: "_blank", rel: "noopener" %>
              </strong>
              <% if post.community.present? %>
                <span>— <%= link_to post.community.slug, community_path(post.community) %></span>
              <% else %>
                <span>— (sin comunidad)</span>
              <% end %>
            </div>

            <div style="display:flex; align-items:center; gap:6px; margin:6px 0;">
              <%= button_to "+", vote_path("Post", post.id, 1), method: :post, form: { style: "display:inline-block;margin-right:4px;" } %>
              <%= button_to "-", vote_path("Post", post.id, -1), method: :post, form: { style: "display:inline-block;margin-right:4px;" } %>
              <strong><%= post.score %></strong>
            </div>

            <div style="font-size: 0.9rem; color: #555;">
              by <%= post.user.display_name %> (@<%= post.user.username %>) ·
              <%= time_ago_in_words(post.created_at) %> ago
              · <%= link_to "view", post_path(post) %>
            </div>

            <% if post.body.present? %>
              <p style="margin:8px 0 0 0;"><%= simple_format(post.body) %></p>
            <% end %>
          </div>
        </div>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>No hay posts todavía.</p>
<% end %>