<h1><%= @post.title %></h1>

<!-- VOTOS DEL POST -->
<div style="display:flex; align-items:center; gap:6px; margin:6px 0;">
  <%= button_to "+", vote_path("Post", @post.id, 1), method: :post,
        form: { style: "display:inline-block;margin-right:4px;" } %>
  <%= button_to "-", vote_path("Post", @post.id, -1), method: :post,
        form: { style: "display:inline-block;margin-right:4px;" } %>
  <strong><%= @post.score %></strong>
</div>

<p style="margin: 8px 0;">
  <strong>Link:</strong> <%= link_to @post.url, @post.url, target: "_blank", rel: "noopener" %><br>
  <strong>Community:</strong>
  <% if @post.community.present? %>
    <%= link_to @post.community.slug, community_path(@post.community) %>
  <% else %>
    (sin comunidad)
  <% end %><br>
  <%= link_to @post.user.display_name, user_path(@post.user) %>
    (@<%= @post.user.username %>)
  · <%= time_ago_in_words(@post.created_at) %> ago
</p>

<% if @post.image.attached? %>
  <div style="margin: 10px 0;">
    <% if @post.image.variable? %>
      <%= image_tag @post.image.variant(resize_to_limit: [900, 600]),
            style: "max-width:100%;height:auto;border-radius:10px;" %>
    <% else %>
      <%= image_tag @post.image, style: "max-width:100%;height:auto;border-radius:10px;" %>
    <% end %>
  </div>
<% end %>

<% if @post.body.present? %>
  <div style="margin-top: 10px;">
    <%= simple_format(@post.body) %>
  </div>
<% end %>

<p style="margin-top: 12px;">
  <% if @post.user_id == current_user.id %>
    <%= link_to "Edit", edit_post_path(@post) %> |
    <%= button_to "Delete", post_path(@post), method: :delete,
          form: { style: "display:inline" },
          data: { confirm: "Segur que vols esborrar aquest post?" } %> |
  <% end %>
  <%= link_to "Back to Posts", posts_path %>
</p>

<hr>

<!-- ORDEN DE COMENTARIOS -->
<% current_sort = params[:sort].presence || "new" %>
<p>
  Comments order:
  <%= link_to "Nou", post_path(@post, sort: "new") %> |
  <%= link_to "Antic", post_path(@post, sort: "old") %>
</p>

<!-- CARGAR COMENTARIOS ORDENADOS -->
<% comments_scope =
     case params[:sort]
     when "old" then @post.comments.includes(:user).oldest_first
     else            @post.comments.includes(:user).newest_first
     end %>

<h2>Comments (<%= comments_scope.count %>)</h2>

<ul style="list-style:none; padding-left:0;">
  <% comments_scope.where(parent_id: nil).each do |c| %>
    <li style="margin:12px 0; padding:8px 0; border-bottom:1px solid #eee;">

      <!-- Comentario principal -->
      <div style="font-size:0.9rem;color:#555;">
        <strong><%= link_to c.user.display_name, user_path(c.user) %></strong>
        · <%= time_ago_in_words(c.created_at) %> ago
      </div>

      <!-- VOTACIÓN DEL COMENTARIO -->
      <div style="display:flex; align-items:center; gap:6px; margin:4px 0;">
        <%= button_to "+", vote_path("Comment", c.id, 1), method: :post,
              form: { style: "display:inline-block;margin-right:4px;" } %>
        <%= button_to "-", vote_path("Comment", c.id, -1), method: :post,
              form: { style: "display:inline-block;margin-right:4px;" } %>
        <strong><%= c.score %></strong>
      </div>

      <div><%= simple_format(c.body) %></div>

      <!-- Formulario para responder -->
      <div style="margin-top:6px;">
        <%= form_with url: post_comments_path(@post, sort: params[:sort]), local: true do |f| %>
          <%= hidden_field_tag "comment[parent_id]", c.id %>
          <%= text_area_tag "comment[body]", nil, rows: 2, placeholder: "Responder...", style: "width:100%;" %><br>
          <%= submit_tag "Responder" %>
        <% end %>
      </div>

      <!-- REPLIES -->
      <% c.replies.order(created_at: :asc).each do |r| %>
        <div style="margin-left:16px; margin-top:8px; padding-left:8px; border-left:2px solid #ddd;">

          <div style="font-size:0.85rem;color:#666;">
            <strong><%= link_to r.user.display_name, user_path(r.user) %></strong>
            · <%= time_ago_in_words(r.created_at) %> ago
          </div>

          <!-- VOTOS DE LA REPLY (CORREGIDO) -->
          <div style="display:flex; align-items:center; gap:6px; margin:6px 0;">
            <%= button_to "+", vote_path("Comment", r.id, 1), method: :post,
                  form: { style: "display:inline-block;margin-right:4px;" } %>
            <%= button_to "-", vote_path("Comment", r.id, -1), method: :post,
                  form: { style: "display:inline-block;margin-right:4px;" } %>
            <strong><%= r.score %></strong>
          </div>

          <div><%= simple_format(r.body) %></div>

          <% if r.user_id == current_user.id %>
            <div style="margin-top:4px;">
              <%= button_to "Delete", comment_path(r), method: :delete,
                    form: { style: "display:inline" },
                    data: { confirm: "Segur que vols esborrar aquesta resposta?" } %>
            </div>
          <% end %>
        </div>
      <% end %>

      <% if c.user_id == current_user.id %>
        <div style="margin-top:4px;">
          <%= button_to "Delete", comment_path(c), method: :delete,
                form: { style: "display:inline" },
                data: { confirm: "Segur que vols esborrar aquest comentari?" } %>
        </div>
      <% end %>
    </li>
  <% end %>
</ul>

<!-- NUEVO COMENTARIO -->
<h3>Nuevo comentario</h3>
<%= form_with url: post_comments_path(@post, sort: params[:sort]), local: true do |f| %>
  <%= hidden_field_tag "comment[parent_id]", nil %>
  <%= text_area_tag "comment[body]", nil, rows: 4,
        placeholder: "Escribe tu comentario…", style: "width:100%;" %><br>
  <%= submit_tag "Comentar" %>
<% end %>
