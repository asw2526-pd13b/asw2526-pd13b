<% content_for :title, (@user.display_name.presence || @user.username) %>
<% active_tab = (@active_tab.presence || params[:tab].presence || "posts") %>

<div class="Hero">
  <div class="HeroBanner">
    <% if @user.banner_url.present? %>
      <img src="<%= @user.banner_url %>" alt="Banner">
    <% end %>
  </div>

  <div class="HeroBody">
    <div class="HeroTop">
      <div class="HeroIdentity">
        <% if @user.avatar_url.present? %>
          <img src="<%= @user.avatar_url %>" alt="<%= @user.username %>" class="HeroAvatar">
        <% else %>
          <div class="HeroAvatarFallback"><%= (@user.username.to_s.first || "u").upcase %></div>
        <% end %>

        <div>
          <h1 class="PageTitle" style="margin:0;"><%= @user.name.presence || @user.display_name.presence || @user.username %></h1>
          <div class="PostMeta" style="margin-top:4px;">
            <span class="Badge">u/<%= @user.username %></span>
            <span>· Member since <%= @user.created_at.strftime("%B %Y") %></span>
          </div>
        </div>
      </div>

      <div class="Pills">
        <% if user_signed_in? && current_user == @user %>
          <%= link_to "Edit profile", edit_user_path(@user), class: "btn btn-primary" %>
        <% end %>
      </div>
    </div>

    <% if @user.bio.present? %>
      <div class="Prose" style="margin-top:10px;"><%= @user.bio %></div>
    <% end %>

    <div class="StatRow">
      <span><strong><%= @user.posts_count %></strong> posts</span>
      <span><strong><%= @user.comments_count %></strong> comments</span>
    </div>
  </div>
</div>

<% if user_signed_in? && current_user == @user %>
  <div class="Card CardPad" style="margin-top:12px;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <div>
        <div style="font-weight:900;margin-bottom:6px;">API Key</div>
        <div style="color:var(--muted);font-size:13px;">Click the field to reveal and select</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex:1;min-width:260px;">
        <input type="password" value="<%= current_user.api_key %>" readonly class="Input" style="font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;" onclick="this.type='text'; this.select();">
        <%= button_to "Regenerate", regenerate_api_key_user_path(@user), method: :post, class: "btn btn-danger", form: { class: "inline" }, data: { confirm: "Estàs segur? L'API key antiga deixarà de funcionar." } %>
      </div>
    </div>
  </div>
<% end %>

<div class="Divider"></div>

<div class="Pills" style="justify-content:space-between;align-items:center;">
  <div class="Tabs">
    <%= link_to "Posts", user_path(@user, tab: "posts"), class: "Tab #{'is-active' if active_tab == 'posts'}" %>
    <%= link_to "Comments", user_path(@user, tab: "comments"), class: "Tab #{'is-active' if active_tab == 'comments'}" %>
  </div>
</div>

<div class="Card CardPad" style="margin-top:12px;box-shadow:none;">
  <% if active_tab == "posts" %>
    <% if @posts.any? %>
      <div class="Stack" style="gap:10px;">
        <% @posts.each do |post| %>
          <div class="Card CardPad" style="box-shadow:none;border-color:var(--border2);background:rgba(255,255,255,.02);">
            <div class="PostMeta" style="margin-top:0;">
              <% if post.community.present? %>
                <span class="Badge"><%= link_to "c/#{post.community.slug}", community_path(post.community) %></span>
              <% end %>
              <span>· <%= time_ago_in_words(post.created_at) %> ago</span>
            </div>
            <h3 class="PostTitle" style="margin-top:8px;">
              <%= link_to post.title, post_path(post) %>
            </h3>
            <% if post.body.present? %>
              <div class="PostExcerpt"><%= truncate(post.body, length: 260) %></div>
            <% end %>
            <div class="PostMeta">
              <span><%= post.comments.count %> comments</span>
              <span>· <%= post.score %> score</span>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="Empty">This user hasn’t posted yet.</div>
    <% end %>
  <% elsif active_tab == "comments" %>
    <% if @comments.any? %>
      <div class="Stack" style="gap:10px;">
        <% @comments.each do |comment| %>
          <div class="Card CardPad" style="box-shadow:none;border-color:var(--border2);background:rgba(255,255,255,.02);">
            <div class="PostMeta" style="margin-top:0;">
              <% if comment.post.present? %>
                <span>on <%= link_to comment.post.title, post_path(comment.post) %></span>
              <% else %>
                <span>on a deleted post</span>
              <% end %>
              <span>· <%= time_ago_in_words(comment.created_at) %> ago</span>
              <span>· <%= comment.score %> score</span>
            </div>
            <div class="Card CardPad" style="margin-top:10px;box-shadow:none;border-color:var(--border2);background:rgba(255,255,255,.02);">
              <div class="Prose"><%= simple_format(comment.body) %></div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="Empty">This user hasn’t commented yet.</div>
    <% end %>
  <% end %>
</div>
